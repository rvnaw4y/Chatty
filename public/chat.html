<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Chatty</title>
  <link rel="stylesheet" href="css/main.css">
</head>
<body>
  <div class="container">
    <!-- Sidebar -->
    <div class="sidebar">
      <div class="sidebar-header">
        <h2>Chatty</h2>
        <button id="newChatBtn" class="new-chat-btn" title="New Chat">+</button>
      </div>
      
      <div class="model-selector">
        <select id="modelSelect">
          <option value="deepseek">Deepseek</option>
          <option value="grok">Grok</option>
        </select>
      </div>

      <div class="chat-history-section">
        <div class="history-label">Recent Chats</div>
        <div class="chat-history" id="chatHistory">
          <!-- Chat history will be loaded here -->
        </div>
      </div>

      <div class="sidebar-footer">
        <button id="resetBtn" class="footer-btn">üîÑ Clear Memory</button>
        <button id="settingsBtn" class="footer-btn">‚öôÔ∏è Settings</button>
        <button id="logoutBtn" class="footer-btn">üö™ Logout</button>
      </div>
    </div>

    <!-- Main Content -->
    <div class="main-content">
      <div class="chat-header">
        <div class="chat-title" id="chatTitle">New Chat</div>
        <div class="chat-header-actions">
          <button id="saveBtn" class="header-btn" title="Save Chat">üíæ</button>
          <button id="shareBtn" class="header-btn" title="Share">üì§</button>
          <button id="renameBtn" class="header-btn" title="Rename">‚úèÔ∏è</button>
        </div>
      </div>

      <div id="chat-box">
        <div class="empty-state">
          <h3>How can I help you today?</h3>
          <p>Start a conversation by typing a message below</p>
        </div>
      </div>

      <div class="input-container">
        <div class="input-wrapper">
          <textarea id="messageBox" placeholder="Message..." rows="1"></textarea>
          <button id="sendBtn" class="send-btn">Send</button>
        </div>
      </div>

      <div class="footer-note">
        Powered by <a href="https://openrouter.ai/">OpenRouter</a> ‚Ä¢ Your chats are saved automatically
      </div>
    </div>
  </div>

  <!-- Modal for renaming chat -->
  <div id="renameModal" class="modal hidden">
    <div class="modal-content">
      <div class="modal-header">
        <h3>Rename Chat</h3>
        <button id="closeRenameModal" class="close-btn">√ó</button>
      </div>
      <input type="text" id="renameInput" placeholder="Enter new chat name..." />
      <div class="modal-actions">
        <button id="cancelRenameBtn" class="modal-btn cancel">Cancel</button>
        <button id="confirmRenameBtn" class="modal-btn confirm">Save</button>
      </div>
    </div>
  </div>

<script>
const chatBox = document.getElementById("chat-box");
const messageBox = document.getElementById("messageBox");
const modelSelect = document.getElementById("modelSelect");
const sendBtn = document.getElementById("sendBtn");
const resetBtn = document.getElementById("resetBtn");
const newChatBtn = document.getElementById("newChatBtn");
const saveBtn = document.getElementById("saveBtn");
const renameBtn = document.getElementById("renameBtn");
const logoutBtn = document.getElementById("logoutBtn");
const chatHistory = document.getElementById("chatHistory");
const chatTitle = document.getElementById("chatTitle");
const emptyState = document.querySelector(".empty-state");
const renameModal = document.getElementById("renameModal");
const renameInput = document.getElementById("renameInput");
const confirmRenameBtn = document.getElementById("confirmRenameBtn");
const closeRenameModal = document.getElementById("closeRenameModal");
const cancelRenameBtn = document.getElementById("cancelRenameBtn");

// State management
let currentChatId = null;
let currentMessages = [];
let chatMessages = {
    deepseek: [],
    grok: [],
    model1: [],
};

// Auto-resize textarea
messageBox.addEventListener('input', function() {
  this.style.height = 'auto';
  this.style.height = Math.min(this.scrollHeight, 200) + 'px';
});

// Escape HTML to prevent injection
function escapeHTML(text) {
  return text
    .replace(/&/g, "&amp;")
    .replace(/</g, "&lt;")
    .replace(/>/g, "&gt;");
}

// Convert Markdown to HTML (bold, italic, strikethrough, code blocks, links, lists, etc)
function markdownToHTML(text) {
  // --- Auto-detect multi-line single backticks ---
  text = text.replace(/`([\s\S]*?)`/g, (match, code) => {
    if (code.includes("\n")) {
      return "```\n" + code + "\n```";
    }
    return match; // leave inline code
  });

  // --- Convert triple-backtick code blocks ---
  text = text.replace(/```(\w+)?\n([\s\S]*?)```/g, (match, lang, code) => {
    return `<pre class="code-block ${lang || ''}"><code>${escapeHTML(code)}</code></pre>`;
  });

  // --- Convert inline code (before other formatting) ---
  text = text.replace(/`([^`\n]+)`/g, (match, code) => {
    return `<code class="inline-code">${escapeHTML(code)}</code>`;
  });

  // --- Convert links ---
  text = text.replace(/\[([^\]]+)\]\(([^)]+)\)/g, (match, title, url) => {
    return `<a href="${escapeHTML(url)}" target="_blank" class="markdown-link">${escapeHTML(title)}</a>`;
  });

  // --- Convert bold italic ***text*** or ___text___ ---
  text = text.replace(/\*\*\*([^\*]+)\*\*\*/g, "<b><i>$1</i></b>");
  text = text.replace(/___([^_]+)___/g, "<b><i>$1</i></b>");

  // --- Convert bold **text** or __text__ ---
  text = text.replace(/\*\*([^\*]+)\*\*/g, "<b>$1</b>");
  text = text.replace(/__([^_]+)__/g, "<b>$1</b>");

  // --- Convert italic *text* or _text_ ---
  text = text.replace(/\*([^\*]+)\*/g, "<i>$1</i>");
  text = text.replace(/_([^_]+)_/g, "<i>$1</i>");

  // --- Convert strikethrough ~~text~~ ---
  text = text.replace(/~~([^~]+)~~/g, "<del>$1</del>");

  // --- Convert unordered lists (-, *, +) ---
  text = text.replace(/(?:^|\n)([\s]*)[-*+]\s+(.+?)(?=\n|$)/gm, (match, indent, item) => {
    return `<li class="markdown-list-item">${item}</li>`;
  });
  text = text.replace(/(<li class="markdown-list-item">.*?<\/li>)/s, (match) => {
    return `<ul class="markdown-list">${match}</ul>`;
  });

  // --- Convert numbered lists ---
  text = text.replace(/(?:^|\n)(\d+)\.\s+(.+?)(?=\n|$)/gm, (match, num, item) => {
    return `<li class="markdown-list-item">${item}</li>`;
  });

  // --- Convert line breaks ---
  text = text.replace(/\n/g, "<br>");

  return text;
}

// Add a message to the chat
function addMessage(content, sender) {
  if (emptyState) emptyState.remove();

  const messageDiv = document.createElement("div");
  messageDiv.classList.add("message", sender);

  const avatar = document.createElement("div");
  avatar.classList.add("message-avatar");
  avatar.textContent = sender === "user" ? "U" : "AI";

  const messageContent = document.createElement("div");
  messageContent.classList.add("message-content");

  // Convert Markdown to HTML
  messageContent.innerHTML = markdownToHTML(content);

  messageDiv.appendChild(avatar);
  messageDiv.appendChild(messageContent);

  chatBox.appendChild(messageDiv);
  chatBox.scrollTop = chatBox.scrollHeight;

  // Store message in current messages
  currentMessages.push({ role: sender === "user" ? "user" : "assistant", content });
}

// Load chats from server
async function loadChatHistory() {
  try {
    const response = await fetch("/api/chats");
    const chats = await response.json();
    
    chatHistory.innerHTML = "";
    if (chats.length === 0) {
      chatHistory.innerHTML = '<div class="no-chats">No chats yet</div>';
      return;
    }

    chats.forEach(chat => {
      const chatItem = document.createElement("div");
      chatItem.classList.add("chat-item");
      chatItem.innerHTML = `
        <div class="chat-item-title">${escapeHTML(chat.title || "Untitled")}</div>
        <div class="chat-item-meta">${chat.model} ‚Ä¢ ${new Date(chat.updated_at).toLocaleDateString()}</div>
        <div class="chat-item-actions">
          <button class="action-btn" title="Load" onclick="loadChat(${chat.id})">üìÇ</button>
          <button class="action-btn delete" title="Delete" onclick="deleteChat(${chat.id})">üóëÔ∏è</button>
        </div>
      `;
      chatHistory.appendChild(chatItem);
    });
  } catch (err) {
    console.error("Error loading chats:", err);
  }
}

// Load specific chat
async function loadChat(chatId) {
  try {
    const response = await fetch(`/api/chat/${chatId}`);
    const chat = await response.json();
    
    currentChatId = chatId;
    currentMessages = chat.messages;
    
    // Clear and reload chat
    chatBox.innerHTML = "";
    chat.messages.forEach(msg => {
      addMessage(msg.content, msg.role === "user" ? "user" : "ai");
    });

    chatTitle.textContent = chat.title || "Chat";
    modelSelect.value = chat.model;
    
    // Update chat memory for model
    chatMessages[chat.model] = chat.messages;
  } catch (err) {
    console.error("Error loading chat:", err);
    addMessage("Error loading chat", "ai");
  }
}

// Save chat
async function saveChat() {
  if (currentMessages.length === 0) return;

  const title = chatTitle.textContent === "New Chat" 
    ? (currentMessages[0]?.content || "Untitled").substring(0, 50)
    : chatTitle.textContent;
  const model = modelSelect.value;

  try {
    let endpoint = "/api/save-chat";
    let method = "POST";
    let body = { title, model, messages: currentMessages };

    if (currentChatId) {
      endpoint = `/api/chat/${currentChatId}`;
      method = "PUT";
    }

    const response = await fetch(endpoint, {
      method,
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(body),
    });

    const data = await response.json();
    if (data.id) currentChatId = data.id;
    
    chatTitle.textContent = title;
    loadChatHistory();
  } catch (err) {
    console.error("Error saving chat:", err);
  }
}

// Delete chat
async function deleteChat(chatId) {
  if (!confirm("Are you sure you want to delete this chat?")) return;

  try {
    await fetch(`/api/chat/${chatId}`, { method: "DELETE" });
    if (currentChatId === chatId) newChatSession();
    loadChatHistory();
  } catch (err) {
    console.error("Error deleting chat:", err);
  }
}

// New chat session
function newChatSession() {
  currentChatId = null;
  currentMessages = [];
  chatBox.innerHTML = '<div class="empty-state"><h3>How can I help you today?</h3><p>Start a conversation by typing a message below</p></div>';
  chatTitle.textContent = "New Chat";
  const model = modelSelect.value;
  chatMessages[model] = [];
}

// Send message to server
async function sendMessage(reset = false) {
  const message = messageBox.value.trim();
  const model = modelSelect.value;
  if (!message && !reset) return;

  if (!reset) addMessage(message, "user");
  messageBox.value = "";
  messageBox.style.height = 'auto';

  addMessage(reset ? "üîÑ Clearing memory..." : "ü§ñ Thinking...", "ai");

  try {
    const response = await fetch(`/api/chat/${model}`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ message, reset }),
    });

    const data = await response.json();

    // Remove the "Thinking..." message
    chatBox.lastChild.remove();

    addMessage(data.reply, "ai");
    
    // Auto-save after each message
    if (!reset) {
      setTimeout(saveChat, 1000);
    }
  } catch (error) {
    chatBox.lastChild.remove();
    addMessage("Error: Could not connect to the server", "ai");
  }
}

// Event listeners
sendBtn.addEventListener("click", () => sendMessage());
resetBtn.addEventListener("click", () => {
  sendMessage(true);
  newChatSession();
});
newChatBtn.addEventListener("click", newChatSession);
saveBtn.addEventListener("click", saveChat);

// Rename chat
renameBtn.addEventListener("click", () => {
  renameInput.value = chatTitle.textContent;
  renameModal.classList.remove("hidden");
  renameInput.focus();
});

confirmRenameBtn.addEventListener("click", async () => {
  const newTitle = renameInput.value.trim();
  if (newTitle && currentChatId) {
    chatTitle.textContent = newTitle;
    currentMessages[0] = { ...currentMessages[0] };
    await saveChat();
  }
  renameModal.classList.add("hidden");
});

closeRenameModal.addEventListener("click", () => {
  renameModal.classList.add("hidden");
});

cancelRenameBtn.addEventListener("click", () => {
  renameModal.classList.add("hidden");
});

// Logout
logoutBtn.addEventListener("click", () => {
  if (confirm("Are you sure you want to logout?")) {
    window.location.href = "/login.html";
  }
});

messageBox.addEventListener("keypress", (e) => {
  if (e.key === "Enter" && !e.shiftKey) {
    e.preventDefault();
    sendMessage();
  }
});

// Load chat history on page load
loadChatHistory();
</script>

</body>
</html>